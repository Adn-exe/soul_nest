{% extends "base.html" %}
{% block title %}Soul Nest - Feed{% endblock %}

{% block content %}
<div class="feed-container" style="display: flex; flex-direction: column; gap: 1.5rem;">

    {% if thoughts %}
        {% for thought in thoughts %}
            <div class="thought-card mood-{{ thought.mood }}" data-aos="fade-up" style="
                padding: 1.8rem 2rem;
                border-radius: 15px;
                /* Background is initially set by CSS in <style> block below */
                box-shadow: 0 12px 25px rgba(0,0,0,0.15);
                transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.4s ease;
            "
            onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 18px 35px rgba(0,0,0,0.25)';"
            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 12px 25px rgba(0,0,0,0.15)';">

                <div class="thought-header" style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div style="
                        width: 40px; height: 40px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, #7b6cf6, #c9a3ff);
                        display: flex; align-items: center; justify-content: center;
                        font-weight: 700; color: white;
                        font-family: 'Zalando Sans SemiExpanded', sans-serif;
                        font-size: 1rem; text-transform: uppercase;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                    ">
                        {{ thought.user.username[0] }}
                    </div>
                    <div>
                        <div style="font-weight: 600; font-size: 0.95rem; color: #333;">
                            {{ thought.user.username }}
                        </div>
                        <div style="font-size: 0.8rem; color: #6c757d;">
                            {{ thought.timestamp.strftime('%b %d, %Y â€¢ %H:%M') }}
                        </div>
                    </div>
                </div>

                <p class="thought-content" style="
                    font-family: 'PT Serif', serif;
                    font-size: 1.15rem; color: #1c1c1c; font-weight: 500;
                    line-height: 1.6; margin-bottom: 0.5rem;
                ">
                    {{ thought.content }}
                </p>

                <div style="height:1px; background:#b0aeaec6; margin-top:0.5rem; margin-bottom:0.5rem; width:100%;"></div>

                <div class="thought-footer" style="display: flex; justify-content: space-between; align-items: center;">

                    <div class="like-section" style="display:flex; align-items:center; gap:0.003rem;">
                        <button type="button" 
                                class="heart-icon {% if thought.is_liked_by(current_user) %}liked{% endif %}" 
                                data-id="{{ thought.id }}" 
                                onclick="toggleLike(this)"
                            style="background:none; border:none; cursor:pointer; display:flex; align-items:center; gap:0.2rem;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="{% if thought.is_liked_by(current_user) %}#e63946{% else %}#d3d3d3{% endif %}" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                        </button>
                        <span id="like-count-{{ thought.id }}" style="font-weight:600;">{{ thought.like_count() }}</span>
                    </div>

                    {% if thought.user_id == current_user.id %}
                        <div style="display:flex; gap:0.5rem;">
                            <a href="{{ url_for('edit_thought', id=thought.id) }}" style="
                                padding:0.35rem 0.7rem; font-size:0.85rem; font-weight:600; border-radius:8px; border:none;
                                background:#4f46e5; color:white; text-decoration:none; cursor:pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.transform='translateY(-2px) scale(1.05)';" onmouseout="this.style.transform='none';">
                                Edit
                            </a>
                            <form action="{{ url_for('delete_thought', id=thought.id) }}" method="POST">
                                <button type="submit" style="
                                    padding:0.35rem 0.7rem; font-size:0.85rem; font-weight:600; border-radius:8px; border:none;
                                    background:#f87171; color:white; cursor:pointer; transition: all 0.3s ease;"
                                    onmouseover="this.style.transform='translateY(-2px) scale(1.05)';" onmouseout="this.style.transform='none';">
                                    Delete
                                </button>
                            </form>
                        </div>
                    {% endif %}

                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="no-thoughts text-center mt-5">
            <h3 style="font-family: 'PT Serif', serif;">No thoughts yet... ðŸŒ±</h3>
            <p style="color: #555;">Share your first thought to start building your soul nest!</p>
        </div>
    {% endif %}
</div>

<style>
    
/* Heart colors and hover */
.heart-icon svg {
    fill: #d3d3d3;
    width: 24px;
    height: 24px;
    display: block;
    background: transparent;
    border-radius: 50%;
    transition: transform 0.2s ease, fill 0.2s ease; 
}
/* IMPORTANT: The heart icon is styled using the 'liked' class on the BUTTON */
.heart-icon.liked svg {
    fill: #e63946;
}

/* Mood hover with gradient + pulse */
.thought-card {
    background: #fafafa;
    transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.4s ease;
}

@keyframes pulseAura {
    0% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
    50% { box-shadow: 0 0 25px 5px rgba(255,255,255,0.2); }
    100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
}

/* Your Mood Gradients */
.mood-happy:hover {
    background: linear-gradient(135deg, rgba(255, 180, 200, 0.9), rgba(255, 210, 150, 0.95));
    animation: pulseAura 2s infinite;
}
.mood-calm:hover {
    background: linear-gradient(135deg, rgba(170, 250, 180, 0.9), rgba(185, 245, 205, 0.9));
    animation: pulseAura 2s infinite;
}
.mood-thoughtful:hover {
    background: linear-gradient(135deg, rgba(200, 180, 250, 0.9), rgba(160, 200, 255, 0.95));
    animation: pulseAura 2s infinite;
}
.mood-sad:hover {
    background: linear-gradient(45deg, rgba(100, 125, 150, 0.9), rgba(180, 205, 230, 0.85));
    animation: pulseAura 2s infinite;
}
.mood-excited:hover {
    background: linear-gradient(135deg, rgba(255, 230, 150, 0.9), rgba(255, 185, 120, 0.95));
    animation: pulseAura 2s infinite;
}
.mood-inspired:hover {
    background: linear-gradient(135deg, rgba(160, 220, 255, 0.9), rgba(255, 240, 180, 0.95));
    animation: pulseAura 2s infinite;
}
</style>

<script>
// FIX: Defining the function on the window object makes it globally accessible
// to the inline 'onclick' handlers in the HTML above.
window.toggleLike = async function(buttonElement) {
    const thoughtId = buttonElement.dataset.id;
    try {
        const res = await fetch(`/like/${thoughtId}`, {
            method: "POST",
            credentials: "same-origin"
        });
        if (!res.ok) {
            console.error("Server error during like toggle.");
            return;
        }
        
        const data = await res.json();
        const svg = buttonElement.querySelector("svg");
        const span = document.getElementById(`like-count-${thoughtId}`);
        
        // Update the heart visual and class
        svg.setAttribute("fill", data.liked ? "#e63946" : "#d3d3d3");
        buttonElement.classList.toggle('liked', data.liked); // Use the class for styling simplicity

        // Update the like count number
        if (span) {
            span.textContent = data.likes;
        }

    } catch (err) {
        console.error("Like failed (network/parsing):", err);
    }
};
</script>

{% endblock %}